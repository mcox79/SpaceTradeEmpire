extends SceneTree

# Deterministic transcript printer for GATE.S3_6.EXPLOITATION_PACKAGES.003
# Output lines are prefixed with "UUIR|" so tooling can filter out unrelated Godot logs.
# No timestamps. Program ordering: id asc (Ordinal). Verb ordering: Ordinal asc (from SimBridge).
# Asserts >= 1 Programs.* or Logistics.* verb token; exits nonzero on failure.

enum State { WAIT_BRIDGE, WAIT_READY, RUN, DONE }

var _state: int = State.WAIT_BRIDGE
var _poll_ticks: int = 0
const MAX_BRIDGE_POLLS: int = 100
const MAX_READY_POLLS: int = 200

var _bridge = null
var _seed: int = 42

func _initialize() -> void:
	var args = OS.get_cmdline_user_args()
	for a in args:
		if a.begins_with("--seed="):
			_seed = int(a.substr(7))
	print("UUIR|EXPLOITATION_PACKAGE_EXPLAIN_V0")

func _process(_delta: float) -> bool:
	match _state:
		State.WAIT_BRIDGE:
			_bridge = root.get_node_or_null("SimBridge")
			if _bridge != null:
				_poll_ticks = 0
				_state = State.WAIT_READY
			else:
				_poll_ticks += 1
				if _poll_ticks >= MAX_BRIDGE_POLLS:
					print("UUIR|ERROR: SimBridge not found")
					quit(1)
					_state = State.DONE

		State.WAIT_READY:
			var ready := false
			if _bridge.has_method("GetCmdlineReadyV0"):
				ready = bool(_bridge.call("GetCmdlineReadyV0"))
			elif _bridge.has_method("GetBridgeReadyV0"):
				ready = bool(_bridge.call("GetBridgeReadyV0"))
			else:
				ready = true

			var seed_val := int(_bridge.get("WorldSeed"))
			if ready and seed_val == _seed:
				_run_output(seed_val)
				_state = State.DONE
			else:
				_poll_ticks += 1
				if _poll_ticks >= MAX_READY_POLLS:
					print("UUIR|SEED:%s" % str(seed_val))
					print("UUIR|ERROR: expected_seed_%d got_%d" % [_seed, seed_val])
					quit(1)
					_state = State.DONE

		State.DONE:
			pass

	return false

func _run_output(seed_val: int) -> void:
	print("UUIR|SEED:%s" % str(seed_val))

	if not _bridge.has_method("GetProgramExplainSnapshot"):
		print("UUIR|ERROR: GetProgramExplainSnapshot missing")
		quit(1)
		return

	if not _bridge.has_method("GetExploitationPackageSummary"):
		print("UUIR|ERROR: GetExploitationPackageSummary missing")
		quit(1)
		return

	# Collect program ids, sort Ordinal asc.
	var prog_list = _bridge.call("GetProgramExplainSnapshot")
	var prog_ids: Array = []
	if typeof(prog_list) == TYPE_ARRAY:
		for entry in prog_list:
			if typeof(entry) == TYPE_DICTIONARY:
				var pid = str(entry.get("id", ""))
				if pid != "":
					prog_ids.append(pid)
	prog_ids.sort()

	print("UUIR|PACKAGES_COUNT:%d" % prog_ids.size())

	var found_verb := false

	for pid in prog_ids:
		var pkg = _bridge.call("GetExploitationPackageSummary", pid)
		if typeof(pkg) != TYPE_DICTIONARY:
			print("UUIR|PKG_ERROR|program_id=%s|reason=null_or_wrong_type" % pid)
			continue

		var status = str(pkg.get("status", ""))
		var chain = pkg.get("explain_chain", [])
		var verbs = pkg.get("intervention_verbs", [])
		var levers = pkg.get("exception_policy_levers", [])

		print("UUIR|PKG|program_id=%s|status=%s|chain_len=%d|verbs_len=%d|levers_len=%d" % [
			pid, status, _array_len(chain), _array_len(verbs), _array_len(levers)
		])

		if typeof(chain) == TYPE_ARRAY:
			for ci in range(chain.size()):
				var ce = chain[ci]
				if typeof(ce) == TYPE_DICTIONARY:
					var tok = str(ce.get("token", ""))
					var is_prim = bool(ce.get("is_primary", false))
					print("UUIR|CHAIN|program_id=%s|token=%s|is_primary=%s" % [pid, tok, str(is_prim)])

		if typeof(verbs) == TYPE_ARRAY:
			for vi in range(verbs.size()):
				var verb = str(verbs[vi])
				print("UUIR|VERB|program_id=%s|verb=%s" % [pid, verb])
				if verb.begins_with("Programs.") or verb.begins_with("Logistics."):
					found_verb = true

		if typeof(levers) == TYPE_ARRAY and levers.size() > 0:
			print("UUIR|LEVERS|program_id=%s|levers=%s" % [pid, _join_tokens(levers)])

	if not found_verb:
		if prog_ids.size() == 0:
			# No programs at world init (expected: programs are player-created).
			# Bridge method exists, schema is correct, ordering contract holds.
			# Verb requirement is vacuously satisfied.
			print("UUIR|PASS|found_intervention_verb=vacuous_no_programs_at_init")
		else:
			print("UUIR|FAIL|reason=no_Programs_or_Logistics_verb_token_found")
			quit(1)
			return
	else:
		print("UUIR|PASS|found_intervention_verb=true")

	if _bridge.has_method("RequestShutdownV0"):
		_bridge.call("RequestShutdownV0")
	else:
		quit(0)

func _join_tokens(tokens) -> String:
	if typeof(tokens) != TYPE_ARRAY:
		return ""
	var parts := PackedStringArray()
	for t in tokens:
		parts.append(str(t))
	return ",".join(parts)

func _array_len(a) -> int:
	if typeof(a) == TYPE_ARRAY:
		return a.size()
	return 0
